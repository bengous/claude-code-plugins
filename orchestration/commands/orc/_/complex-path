## COMPLEX Path Execution

1. **Determine base branch prefix** based on task type:
   - `feat/` for new features
   - `fix/` for bug fixes
   - `refactor/` for refactoring
   - `chore/` for maintenance

2. **Create base branch safely:**
   - `git fetch origin`
   - Ensure clean tree: `git status --porcelain` must be empty; otherwise update state to aborted: `jq '.status="aborted"' .claude/run/$RUN_ID.json > .claude/run/$RUN_ID.json.tmp && mv .claude/run/$RUN_ID.json.tmp .claude/run/$RUN_ID.json`, print `[ORC_ABORTED]`, ask user to commit/stash, and stop
   - Diverge from upstream source: `git checkout -b <prefix><descriptive-name> origin/<base-divergence>` (default `<base-divergence>` is `dev`, so: `origin/dev`)

3. **Acquire lock:**
   - Set target branch: `<target-branch>` = the dedicated base branch just created
   - Create lock on `<target-branch>`
   - Update run state to status="executing"
   - Update current: `echo '{"type":"COMPLEX","base":"<base-branch>"}' > .claude/run/current.json`

4. **Break down task into logical steps** (bullet list or â‰¤20 lines YAML):
   ```yaml
   steps:
     - name: Step 1 description
       branch: <prefix><name>-step1
     - name: Step 2 description
       branch: <prefix><name>-step2
   ```

5. **For each step:**
   - Create feature branch from base: `git checkout -b <step-branch> <base-branch>`
   - Implement step
   - Create PR: `/pr:create --head <step-branch> --base <base-branch>`
   - **After checks/hooks pass, merge the step PR into `<base-branch>`**
   - **Never** merge to `dev` here

6. **After all steps complete:**
   - Create final PR: `/pr:create --head <base-branch> --base dev`
   - Inform user: "Final PR created. Ready for review. DO NOT auto-merge to dev."

7. **Mark completion and release lock:**
   - Remove lock: `rm -f .claude/run/locks/<target-branch>.lock`
   - Update state: `jq '.status="completed"' .claude/run/$RUN_ID.json > .claude/run/$RUN_ID.json.tmp && mv .claude/run/$RUN_ID.json.tmp .claude/run/$RUN_ID.json`
   - Update current: `echo '{"type":"COMPLEX","base":"<base-branch>","status":"completed"}' > .claude/run/current.json`
   - Print `[ORC_COMPLETED]`
