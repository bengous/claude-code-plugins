#!/usr/bin/env bash
# gemini - Wrapper for Google Gemini CLI
#
# Configuration (environment variables):
#   GEMINI_MODEL      Model override (uses CLI default if unset)
#   GEMINI_SANDBOX    Enable sandbox mode (default: false)
#   GEMINI_YOLO       Auto-approve all actions (default: false)
#
# Usage:
#   gemini                           # Interactive mode
#   gemini "Review this code"        # One-shot with prompt
#   gemini -i "Start here"           # Interactive with initial prompt
#   gemini --info                    # Show current config and options
#   GEMINI_MODEL=<model> gemini      # Use specific model
set -euo pipefail

# Find the real gemini binary (not this wrapper)
find_real_binary() {
	local self="$(realpath "${BASH_SOURCE[0]}")"
	while IFS= read -r path; do
		[[ "$(realpath "$path")" != "$self" ]] && { echo "$path"; return 0; }
	done < <(type -ap gemini)
	return 1
}

real_gemini="$(find_real_binary)" || {
	echo "Error: gemini not found in PATH" >&2
	echo "Install: https://github.com/google-gemini/gemini-cli" >&2
	exit 1
}

# Show config and available options
show_info() {
	echo "=== Gemini CLI Info ==="
	echo
	echo "Binary: $real_gemini"
	"$real_gemini" --version 2>/dev/null || true
	echo
	echo "=== Environment Overrides ==="
	echo "GEMINI_MODEL=${GEMINI_MODEL:-(not set)}"
	echo "GEMINI_SANDBOX=${GEMINI_SANDBOX:-(not set)}"
	echo "GEMINI_YOLO=${GEMINI_YOLO:-(not set)}"
	echo
	echo "=== Available Options (from --help) ==="
	"$real_gemini" --help 2>&1 | grep -E "^\s+-(m|s|y|i)," | head -10 || true
	echo
	echo "=== Model Discovery ==="
	echo "Run 'gemini' then '/model' to list available models"
	echo "Run 'gemini' then '/settings' to see current settings"
	exit 0
}

[[ "${1:-}" == "--info" ]] && show_info

args=()

[[ -n "${GEMINI_MODEL:-}" ]] && args+=(-m "$GEMINI_MODEL")
[[ "${GEMINI_SANDBOX:-false}" == "true" ]] && args+=(-s)
[[ "${GEMINI_YOLO:-false}" == "true" ]] && args+=(-y)

exec "$real_gemini" "${args[@]}" "$@"
